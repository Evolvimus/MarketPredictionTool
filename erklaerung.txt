# Technische Dokumentation: Das 3-Modell Trading System

Diese Dokumentation erklärt im Detail die mathematischen Grundlagen und die logische Architektur des Trading Analysers.

---

## 1. Feature Engineering: Mathematische Berechnungen

Der C++ Kern extrahiert hochpräzise Features. Hier sind die Formeln:

### A. Relative Strength Index (RSI)
Misst die Geschwindigkeit und Veränderung von Preisbewegungen.
*   **Formel:** $RSI = 100 - \frac{100}{1 + RS}$
*   wobei $RS = \frac{\text{Durchschnittlicher Gewinn}}{\text{Durchschnittlicher Verlust}}$ über 14 Perioden.
*   **Anwendung:** Erkennt überkaufte (>70) oder überverkaufte (<30) Zustände.

### B. MACD (Moving Average Convergence Divergence)
*   **MACD Linie:** $EMA_{12}(\text{Preis}) - EMA_{26}(\text{Preis})$
*   **Signal Linie:** $EMA_9(\text{MACD Linie})$
*   **Histogramm:** $MACD Linie - Signal Linie$
*   **Anwendung:** Kreuzungen über Null signalisieren Bullish Momentum.

### C. ADX (Average Directional Index)
Bestimmt die Trendstärke (nicht die Richtung).
1.  Berechne Directional Movement ($+DM, -DM$).
2.  Berechne True Range ($TR$).
3.  $DI+ = 100 \times \frac{EMA(+DM)}{EMA(TR)}$
4.  $DI- = 100 \times \frac{EMA(-DM)}{EMA(TR)}$
5.  $DX = 100 \times \frac{|DI+ - DI-|}{DI+ + DI-}$
6.  **ADX:** $EMA(DX)$
*   **Schwellenwert:** ADX > 25 bedeutet ein starkes Trend-Umfeld.

### D. Bollinger Bands & Width
*   **Middle Band:** $SMA_{20}$
*   **Upper Band:** $SMA_{20} + (2 \times \sigma)$
*   **Lower Band:** $SMA_{20} - (2 \times \sigma)$
*   **Bollinger Width:** $\frac{\text{Upper} - \text{Lower}}{\text{Middle}}$
*   **Anwendung:** Eine geringe Width (< 0.02) deutet auf eine bevorstehende "Squeeze" (Explosion) hin.

### E. Volume Z-Score
Misst, wie extrem das aktuelle Volumen im Vergleich zum Durchschnitt ist.
*   **Formel:** $Z = \frac{V_{current} - \mu_{V}}{\sigma_{V}}$
*   wobei $\mu_{V}$ der Durchschnitt und $\sigma_{V}$ die Standardabweichung des Volumens der letzten 20 Perioden ist.
*   **Anwendung:** Z > 2.0 signalisiert institutionelles Interesse oder Panik (Capitulation).

### F. ATR (Average True Range) Median
Wir berechnen nicht nur den gleitenden ATR, sondern vergleichen ihn mit dem 20-Perioden-Median.
*   **Formel:** $ATR_{Rel} = \frac{ATR_{14}}{Median(ATR_{1-20})}$
*   **Anwendung:** Wenn $ATR_{Rel} > 1.5$, befinden wir uns im High Volatility Regime.

---

## 2. Phase 1: Market Regime Classification (Code-Logik)

In `analysis.cpp` und `ml_predict.py` wird das Regime wie folgt hart-codiert und durch ML-Features verfeinert:

1.  **Event Risk:** Wenn Nachrichten-Keywords wie "CPI", "Fed" oder "Earnings" gefunden werden -> **Event Risk**.
2.  **Trend:** Wenn $ADX > 25$ UND der Preisabstand zum $SMA_{50}$ mehr als 2% beträgt -> **Trend**.
3.  **High Vol:** Wenn $ATR / Median(ATR) > 1.5$ -> **High Vol**.
4.  **Range:** Wenn keine der obigen Bedingungen zutrifft -> **Range**.

---

## 3. Phase 2: Directional Prediction (Algorithmischer Flow)

Das Python-Modell (`ml_predict.py`) berechnet eine **Long Probability ($P_L$)** und eine **Short Probability ($P_S$)**:

*   **Long Bias ($P_L$):**
    *   Start bei 0.5.
    *   $+0.15$ wenn $RSI < 35$ (Mean Reversion Chance).
    *   $+0.10$ wenn $MACD > 0$.
    *   $+0.10$ wenn $Volume\_Z > 1.5$ (Capitulation).
*   **Short Bias ($P_S$):**
    *   Start bei 0.5.
    *   $+0.15$ wenn $RSI > 65$.
    *   $+0.10$ wenn $MACD < 0$.

**Entscheidung:** Nur wenn $P_L$ oder $P_S \ge 0.60$, wird eine Richtung (Long/Short) ausgegeben, sonst **Neutral**.

---

## 4. Phase 3: Meta-Analyst (LLM Integration)

Die KI (Llama 3) fungiert als "Circuit Breaker". Sie prüft:
1.  **Logical Consistency:** Sagt das ML-Modell "Long", während der RSI bei 85 steht? (Widerspruch!)
2.  **Sentiment Alignment:** Passen die aktuellen News zum technischen Signal?
3.  **Veto:** Bei Inkonsistenzen setzt das LLM `decision: "veto"`.

---

## 5. System-Architektur & Datenfluss

Der gesamte Prozess erfolgt in Millisekunden:
1.  **C++ Backend:** Lädt 500 Kerzen -> Berechnet Features -> Erstellt JSON-Payload.
2.  **Bridge:** C++ ruft `python3 scripts/ml_predict.py` via Pipe auf und übergibt die Features.
3.  **Python:** Berechnet Regime und Wahrscheinlichkeit -> Gibt JSON zurück.
4.  **Meta-Analyst:** C++ sendet alle Daten + ML-Ergebnis an die Ollama API.
5.  **Storage:** Das Gesamtergebnis wird in `analyses.json` persistiert.

---

## 6. Risk Management: ATR-basiertes TP/SL

Berechnung der Level basierend auf der Volatilität (ATR - Average True Range).

*   **Entry:** Aktueller Preis ($P$)
*   **Stop Loss (SL):** $P - (Multiplier_{SL} \times ATR)$
*   **Take Profit (TP):** $P + (Multiplier_{TP} \times ATR)$

**Multiplikatoren je nach Regime:**
*   **Trend:** $SL = 1.0, TP = 3.0$ (Risk/Reward 1:3)
*   **Range:** $SL = 1.0, TP = 1.5$ (Risk/Reward 1:1.5)

---

## 7. Erweiterte Optimierungen (V2.0)

Das System wurde um Multi-Timeframe (MTF) Analyse und adaptive ML-Modelle erweitert.

### A. Neue Indikatoren & Mathematik

1.  **Rate of Change (ROC):**
    *   **Formel:** $ROC = \frac{Price_{now} - Price_{n}}{Price_{n}} \times 100$
    *   Bestimmt das Momentum über 5, 10 und 20 Perioden.

2.  **On-Balance Volume (OBV):**
    *   **Logik:** 
        *   Wenn $Price > Prev\_Price$: $OBV = Prev\_OBV + Volume$
        *   Wenn $Price < Prev\_Price$: $OBV = Prev\_OBV - Volume$
    *   Bestimmt den kumulativen Volumenfluss zur Bestätigung von Trends.

3.  **VWAP Distance:**
    *   **Formel:** $VWAP\_Dist = \frac{Price - VWAP}{ATR}$
    *   Misst die Abweichung vom volumengewichteten Durchschnittspreis in ATR-Einheiten.

4.  **Multi-Timeframe (MTF) RSI:**
    *   Berechnet den RSI auf Wochenbasis ($1wk$) zusätzlich zum Tages-RSI ($1d$).
    *   Alignment-Check: Trend gilt als bestätigt, wenn $RSI_{1d} > 50$ und $RSI_{1wk} > 50$.

### B. Adaptive ML Logik (Python Bridge)

1.  **Regime-Kontinuität:**
    *   Der Regime Classifier berechnet einen kontinuierlichen Score:
    *   $Trend\_Score = (\frac{ADX}{50} \times 0.4) + (\frac{|ROC_{20}|}{5} \times 0.4) + (\frac{|RSI_{1wk}-50|}{25} \times 0.2)$

2.  **Wahrscheinlichkeits-Kalibrierung:**
    *   ML-Vorhersagen werden mittels Sigmoid-Funktion kalibriert ($k=8$):
    *   $P(calibrated) = \frac{1}{1 + e^{-(Score - 0.5) \times 8}}$

### C. Erweitertes Risk Management

1.  **Trailing Stop Loss:** Dynamisches Nachziehen des $SL$ zur Gewinnsicherung.
2.  **Partial Take Profit (PTP):** Schließen von 50% der Position bei $1.0 \times ATR$ Gewinn.

### D. Meta-Analyst (LLM) Upgrades

*   **HTF-Confirmation:** Expliziter Check auf Alignment zwischen Tages-Signal und Wochen-Trend.
*   **Trade Annotation:** Erzeugung einer prägnanten Handelsnotiz ("Trend intakt, TP/SL passt zum Regime").
